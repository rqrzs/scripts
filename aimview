local rs = game:GetService("RunService")
local localPlayer = game.Players.LocalPlayer
local mouse = localPlayer:GetMouse()
local target

local TweenService = game:GetService("TweenService")

-- Create the Beam
local a = Instance.new("Beam")
a.Segments = 1
a.Width0 = 0.2
a.Width1 = 0.2
a.FaceCamera = true

local b = Instance.new("Attachment")
local c = Instance.new("Attachment")
a.Attachment0 = b
a.Attachment1 = c
a.Parent = workspace.Terrain
b.Parent = workspace.Terrain
c.Parent = workspace.Terrain

-- Function to get the gun
function getgun()
    for i, v in pairs(target.Character:GetChildren()) do
        if v and (v:FindFirstChild('Default') or v:FindFirstChild('Handle')) then
            return v
        end
    end
end

-- Function to get the closest player
function get_closet()
    local a = math.huge
    local b

    for i, v in pairs(game.Players:GetPlayers()) do
        if v ~= localPlayer and v.Character and v.Character:FindFirstChild("Head") and v.Character:FindFirstChild("HumanoidRootPart") then
            local c = game.Workspace.CurrentCamera:WorldToViewportPoint(v.Character.PrimaryPart.Position)
            local d = (Vector2.new(mouse.X, mouse.Y) - Vector2.new(c.X, c.Y)).Magnitude

            if a > d then
                b = v
                a = d
            end
        end
    end

    return b
end

-- Keybind handling
mouse.KeyDown:Connect(function(z)
    if z == _G.toggle_keybind then
        _G.enable = not _G.enable
    end
end)

mouse.KeyDown:Connect(function(z)
    if z == _G.swith_nigga then
        target = get_closet()
    end
end)

-- Function to tween the beam color
local function tweenBeamColor()
    local tweenInfo = TweenInfo.new(2, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1, true)

    local colorSequence = {
        Color3.fromRGB(25, 25, 25),
        Color3.fromRGB(230, 230, 230),
        Color3.fromRGB(24, 24, 24),
    }

    for _, color in ipairs(colorSequence) do
        local tween = TweenService:Create(a, tweenInfo, {Color = ColorSequence.new(color)})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- Start color tweening
task.spawn(tweenBeamColor)

-- Main loop to update beam position
task.spawn(function()
    rs.RenderStepped:Connect(function()
        local character = localPlayer.Character
        if not character then
            a.Enabled = false
            return
        end

        if _G.enable and getgun() and target.Character:FindFirstChild("BodyEffects") and target.Character:FindFirstChild("Head") then
            a.Enabled = true
            b.Position = target.Character:FindFirstChild("Head").Position
            c.Position = target.Character.BodyEffects[_G.method].Value -- Edit this if some game has a different name
        else
            a.Enabled = false
        end
    end)
end)
